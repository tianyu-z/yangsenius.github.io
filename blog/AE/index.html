<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
 <script type="text/javascript" src="/html_style/head.js"></script>
</head>
<body >
    <script type="text/javascript" src="/html_style/body.js"></script>

<!--  网页主题部分   --><!--  网页主题部分   --><!--  网页主题部分   --><!--  网页主题部分   -->
<!--  网页主题部分   --><!--  网页主题部分   --><!--  网页主题部分   --><!--  网页主题部分   -->

<div class="mume markdown-preview   ">
  <h1 class="mume-header" id="associative-embedding-end-to-end-learning-for-joint-detection-and-grouping">Associative embedding: End-to-End Learning for Joint Detection and Grouping</h1>

<p>2018.04.07：</p>
<hr>
<h2 class="mume-header" id="%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB">论文阅读</h2>

<p>这篇文章的核心思想是比较精炼概括的，它的亮点是用一个框架解决了在计算机视觉中常见的任务中经常遇到的两个通用环节：Detection and Grouping，用中文来讲就是，检测（小的视觉单元作为候选）和（根据得分）重组（一个合理的结构）。</p>
<p>从以下的视觉任务中可以体现：</p>
<ul>
<li>
<p><strong>人体姿态估计问题</strong>：一般按照bottom-to-up的方式，先检测出body key points然后按照约束来组合完整的人体，但多人姿态估计的问题又衍生出另一种up-down的方式，就是先检测出单个人体再识别其姿态，比如Mask R-CNN, RMPE等方法。</p>
</li>
<li>
<p><strong>目标检测</strong>：往往先寻找不同位置和尺度下的bounding boxes，然后打分筛选</p>
</li>
<li>
<p><strong>实例分割</strong>：寻找相关联的像素，然后将像素合理重组成物体实例（mask）。</p>
</li>
<li>
<p><strong>多目标追踪</strong>：检测物体实例，重组其运动轨迹</p>
</li>
</ul>
<p>这些方式，本质上都符合人类自身视觉从部分认识整体，以整体推理部分的直觉。以往的工作都认识到这一点，只是这篇论文做了一次提炼概括了，并指出了一个问题：</p>
<p>以往的两步策略（detection ﬁrst and grouping second）忽略了两个环节之间内在的紧密耦合。</p>
<blockquote>
<p>（在之前看的CMU的Realtime Multi-Person2D Pose Estimation using Part Affinity<br>
Fields, 他们的论文当中，除了人体关键点作为监督信息外，还引入了Part Affinity<br>
Fields，也就是和肢体方向保持一致的单位向量作为监督信号，我的感觉是，这实际上就是没有充分利用两个环节上的耦合性，或者说是人体关键点与肢体连接的耦合性信息，毕竟人体的关节与整体的关系是统一的，<br>
而OpenPose用的是寻找最佳的图匹配的方式，但同时将关键点位置，和肢体向量同时作为监督信息，会导致信息冗余，增加复杂度吧？所以我觉得作者这种融合两步的思想就很实际，很前卫）</p>
</blockquote>
<p>所以作者针对多人体姿态估计，将两步工作融入到一个框架里，即在一般的输出Heatmap层，附加了一层作为“tag“（也就是论文提到的embedding的含义），并设计了一个grouping loss作为监督关键点是否分配给了正确的人体的函数。论文巧妙的地方就是没有给“tag”赋予”ground-truth”来作为强监督，而是用“tag“值的相似与差异来表示多个人体。用于预测Heatmap的网络架构基于作者之前的工作“Stacked Hourglass”.</p>
<p>论文中Related work中的Perceptual Organization的叙述部分，给我了比较多的启示：</p>
<blockquote>
<p>Perceptual Organization是感知组织的意思，我理解成人类在认识事物或概念所遵循的层级组织关系。所谓的强人工智能，就需要解决这一棘手问题吧。作者提到了这一工作涉及到的许多任务，有Figure–ground segmentation<br>
(perception)，hierarchical image parsing， spectral clustering，conditional random ﬁelds，generative probabilistic models等等一系列问题，这些方法都遵循，从pre-detect visual units到measure affinity，再到grouping，但是目前没有统一到一个统一的架构上来，作者就是从这角度出发，不加一些额外的设计来完成一个端到端的网络架构。作者提到了图像层级解析，特别符合人类认知图像，所以，作者的Hourglass模块设计成沙漏状，先是压缩图像，获得全局信息，然后利用全局信息与低层特征融合，输出一个与同样大小的heatmap，其实就是想将这样的层级解析的思想间接地蕴含在内，只不过网络的训练将这些信息都隐含在了参数里，无法与人的解析思路类比</p>
</blockquote>
<h2 class="mume-header" id="%E6%94%B9%E8%BF%9B%E6%83%B3%E6%B3%95">改进想法</h2>

<p>2018.7.5</p>
<p>论文重要的一点引入了‘embedding’，或者叫‘tag’。它是沟通detection和grouping中间的媒介，作者用1D的标量值来表示‘tag’，论文的原话是：</p>
<blockquote>
<p>&quot;In practice we have found that 1D embedding is sufﬁcient for multiperson pose estimation,and higher dimensions do not lead to signiﬁcant improvement.&quot;</p>
</blockquote>
<p>作者没有做出详细的论证，只是从实践的角度说明了1D表示的合理性，这个标量的数值的具体含义是什么呢，不清楚，但它和‘mask’概念有着很大的关联。如果说，用向量或者矩阵来表示这个‘tag’是否可行呢？比如可以表示人的尺度、姿态、位置、等等属性，（参考capsules）。</p>
<p><strong>回头做个实验，用单纯的背景，复制相同的人体，或者对比变换，喂给test做实验，来判断输出的tag的变化</strong></p>
<p>作者别出心裁的设计是，他没有给‘tag’引入绝对的数值标签作为监督，而是把“相同的实例，tag有着相似的取值，不同的实例的tag的取值存在差异”的原则作为一个监督，来设计loss函数--（tagloss，group loss）。</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mrow><mi>g</mi><mi>r</mi><mi>o</mi><mi>u</mi><mi>p</mi></mrow></msub><mrow><mo fence="true">(</mo><mi>h</mi><mo separator="true">,</mo><mi>T</mi><mo fence="true">)</mo></mrow><mo>=</mo><mfrac><mrow><mn>1</mn></mrow><mrow><mi>N</mi></mrow></mfrac><munder><mo>∑</mo><mi>n</mi></munder><munder><mo>∑</mo><mi>k</mi></munder><msup><mrow><mo fence="true">(</mo><msub><mover accent="true"><mrow><mi>h</mi></mrow><mo>ˉ</mo></mover><mi>n</mi></msub><mo>−</mo><msub><mi>h</mi><mi>k</mi></msub><mrow><mo fence="true">(</mo><msub><mi>x</mi><mrow><mi>n</mi><mi>k</mi></mrow></msub><mo fence="true">)</mo></mrow><mo fence="true">)</mo></mrow><mn>2</mn></msup><mo>+</mo><mfrac><mrow><mn>1</mn></mrow><mrow><msup><mi>N</mi><mn>2</mn></msup></mrow></mfrac><munder><mo>∑</mo><mi>n</mi></munder><munder><mo>∑</mo><msup><mi>n</mi><mo mathvariant="normal">′</mo></msup></munder><mi>e</mi><mi>x</mi><mi>p</mi><mrow><mo fence="true">{</mo><mo>−</mo><mfrac><mrow><mn>1</mn></mrow><mrow><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac><msup><mrow><mo fence="true">(</mo><msub><mover accent="true"><mrow><mi>h</mi></mrow><mo>ˉ</mo></mover><mi>n</mi></msub><mo>−</mo><msub><mover accent="true"><mrow><mi>h</mi></mrow><mo>ˉ</mo></mover><msup><mi>n</mi><mo mathvariant="normal">′</mo></msup></msub><mo fence="true">)</mo></mrow><mn>2</mn></msup><mo fence="true">}</mo></mrow></mrow><annotation encoding="application/x-tex">L_{group}\left ( h,T \right )=\frac{1}{N}\sum_{n}\sum_{k}\left ( \bar{h}_{n}-h_{k}\left ( x_{nk} \right ) \right )^{2}+\frac{1}{N^{2}}\sum_{n}\sum_{{n}&#x27;}exp\left \{ -\frac{1}{2\sigma ^{2}} \left (  \bar{h}_{n}-\bar{h}_{{n}&#x27;}\right )^{2}\right \}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.45em;"></span><span class="strut bottom" style="height:2.7521129999999996em;vertical-align:-1.3021129999999999em;"></span><span class="base"><span class="mord"><span class="mord mathit">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathit mtight" style="margin-right:0.03588em;">g</span><span class="mord mathit mtight" style="margin-right:0.02778em;">r</span><span class="mord mathit mtight">o</span><span class="mord mathit mtight">u</span><span class="mord mathit mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"></span></span></span></span></span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord mathit">h</span><span class="mpunct">,</span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.10903em;">N</span></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.2em;"><svg width="400em" height="0.2em" viewBox="0 0 400000 200" preserveAspectRatio="xMinYMin slice"><path d="M0 80H400000 v40H0z M0 80H400000 v40H0z"></path></svg></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8999949999999999em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathit mtight">n</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.250005em;"></span></span></span></span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0500050000000005em;"><span style="top:-1.847887em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathit mtight" style="margin-right:0.03148em;">k</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3021129999999999em;"></span></span></span></span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8312199999999998em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">h</span></span></span><span style="top:-3.26344em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;">ˉ</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathit mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathit">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathit mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathit">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathit mtight">n</span><span class="mord mathit mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.054008em;"><span style="top:-3.3029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathit" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.2em;"><svg width="400em" height="0.2em" viewBox="0 0 400000 200" preserveAspectRatio="xMinYMin slice"><path d="M0 80H400000 v40H0z M0 80H400000 v40H0z"></path></svg></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8999949999999999em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathit mtight">n</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.250005em;"></span></span></span></span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8560149999999997em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathit mtight">n</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6828285714285715em;"><span style="top:-2.786em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2939850000000002em;"></span></span></span></span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="mord mathit">e</span><span class="mord mathit">x</span><span class="mord mathit">p</span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">{</span></span><span class="mord">−</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.2em;"><svg width="400em" height="0.2em" viewBox="0 0 400000 200" preserveAspectRatio="xMinYMin slice"><path d="M0 80H400000 v40H0z M0 80H400000 v40H0z"></path></svg></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8312199999999998em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">h</span></span></span><span style="top:-3.26344em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;">ˉ</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathit mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8312199999999998em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">h</span></span></span><span style="top:-3.26344em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;">ˉ</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32797999999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathit mtight">n</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6828285714285715em;"><span style="top:-2.786em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.054008em;"><span style="top:-3.3029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">}</span></span></span></span></span></span></span></p>
<p>其中：<br>
<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>h</mi><mi>k</mi></msub><mo>∈</mo><msup><mi>R</mi><mrow><mi>W</mi><mo>×</mo><mi>H</mi></mrow></msup><mo separator="true">,</mo><mi>h</mi><mo>(</mo><mi>x</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">h_{k}\in R^{W\times H},h(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.8413309999999999em;"></span><span class="strut bottom" style="height:1.0913309999999998em;vertical-align:-0.25em;"></span><span class="base"><span class="mord"><span class="mord mathit">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathit mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathit mtight" style="margin-right:0.13889em;">W</span><span class="mbin mtight">×</span><span class="mord mathit mtight" style="margin-right:0.08125em;">H</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="mord mathit">h</span><span class="mopen">(</span><span class="mord mathit">x</span><span class="mclose">)</span></span></span></span>代表像素位置<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base"><span class="mord mathit">x</span></span></span></span>的tag取值,<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base"><span class="mord mathit" style="margin-right:0.13889em;">T</span></span></span></span>代表的groudtruth构成的坐标集<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>T</mi><mo>=</mo><mrow><mo fence="true">{</mo><mrow><mo fence="true">(</mo><msub><mi>x</mi><mrow><mi>n</mi><mi>k</mi></mrow></msub><mo fence="true">)</mo></mrow><mo fence="true">}</mo></mrow><mo separator="true">,</mo><mi>n</mi><mo>=</mo><mn>1</mn><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><mi>N</mi><mo separator="true">,</mo><mi>k</mi><mo>=</mo><mn>1</mn><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><mi>K</mi></mrow><annotation encoding="application/x-tex">T=\left \{ \left ( x_{nk} \right ) \right \},n=1,...,N,k=1,...,K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base"><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">{</span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathit">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathit mtight">n</span><span class="mord mathit mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mclose delimcenter" style="top:0em;">}</span></span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="mord mathit">n</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mpunct">,</span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="mord mathit" style="margin-right:0.10903em;">N</span><span class="mpunct">,</span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="mord mathit" style="margin-right:0.03148em;">k</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mpunct">,</span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="mord mathit" style="margin-right:0.07153em;">K</span></span></span></span><br>
<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mover accent="true"><mrow><mi>h</mi></mrow><mo>ˉ</mo></mover><mi>n</mi></msub><mo>=</mo><mfrac><mrow><mn>1</mn></mrow><mrow><mi>K</mi></mrow></mfrac><msub><mo>∑</mo><mi>k</mi></msub><msub><mi>h</mi><mi>k</mi></msub><mrow><mo fence="true">(</mo><msub><mi>x</mi><mrow><mi>n</mi><mi>k</mi></mrow></msub><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\bar{h}_{n}=\frac{1}{K}\sum_{k}h_{k}\left ( x_{nk} \right )</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.845108em;"></span><span class="strut bottom" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="base"><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8312199999999998em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">h</span></span></span><span style="top:-3.26344em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;">ˉ</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathit mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathit mtight" style="margin-right:0.07153em;">K</span></span></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.2em;"><svg width="400em" height="0.2em" viewBox="0 0 400000 200" preserveAspectRatio="xMinYMin slice"><path d="M0 80H400000 v40H0z M0 80H400000 v40H0z"></path></svg></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1863979999999999em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathit mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29971000000000003em;"></span></span></span></span></span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathit">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathit mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathit">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathit mtight">n</span><span class="mord mathit mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span></p>
<p>这里对于单个人求所有关键点的tag均值<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mover accent="true"><mrow><mi>h</mi></mrow><mo>ˉ</mo></mover><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">\bar{h}_{n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.8312199999999998em;"></span><span class="strut bottom" style="height:0.9812199999999999em;vertical-align:-0.15em;"></span><span class="base"><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8312199999999998em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">h</span></span></span><span style="top:-3.26344em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;">ˉ</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathit mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span></span></span></span>作为一个参考嵌入（reference embedding）,然后希望隶属用一人体的关键点位置的tag值尽可能接近<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mover accent="true"><mrow><mi>h</mi></mrow><mo>ˉ</mo></mover><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">\bar{h}_{n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.8312199999999998em;"></span><span class="strut bottom" style="height:0.9812199999999999em;vertical-align:-0.15em;"></span><span class="base"><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8312199999999998em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">h</span></span></span><span style="top:-3.26344em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;">ˉ</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathit mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span></span></span></span>。不同的人体，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mover accent="true"><mrow><mi>h</mi></mrow><mo>ˉ</mo></mover><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">\bar{h}_{n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.8312199999999998em;"></span><span class="strut bottom" style="height:0.9812199999999999em;vertical-align:-0.15em;"></span><span class="base"><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8312199999999998em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">h</span></span></span><span style="top:-3.26344em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;">ˉ</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathit mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span></span></span></span>差距尽可能大。我觉得这一点可以先做几个思考：</p>
<ul>
<li>
<p>1.求<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mover accent="true"><mrow><mi>h</mi></mrow><mo>ˉ</mo></mover><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">\bar{h}_{n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.8312199999999998em;"></span><span class="strut bottom" style="height:0.9812199999999999em;vertical-align:-0.15em;"></span><span class="base"><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8312199999999998em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">h</span></span></span><span style="top:-3.26344em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;">ˉ</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathit mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span></span></span></span>值时用的参考groudtruth的位置求取所有关键点位置tag值的均值，是否合理，初始值如何设定？为什么不求一个区域mask的tag均值？</p>
</li>
<li>
<p>2.两人各出现重叠时，tag的值是否就意味着接近呢？比如某个人的手臂与另外一个人连在了一起？</p>
</li>
<li>
<p>3.这样的设计对哪些情况效果不好，loss发散导致关键点检测率的下降？</p>
</li>
</ul>
<p>我的想法是：1.  1D的tag值变成矩阵或者向量，参考capsules<br>
1.  把多个关键点当作数据（观察，果），把实例当作隐变量（因），寻找最佳匹配？<br>
2.  连续的mask区域，代替稀疏的点构成的骨架？</p>
<h2 class="mume-header" id="%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5">工程实践</h2>

<p>2018.4.27</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token triple-quoted-string string">'''coco_pose/dp.py'''</span>
<span class="token keyword">class</span> <span class="token class-name">GenerateHeatmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#从标签点生成关节点的Heatmap热值图响应，</span>
    <span class="token triple-quoted-string string">'''resolution：128x128  parts：17'''</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> output_res<span class="token punctuation">,</span> num_parts<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>output_res <span class="token operator">=</span> output_res
        self<span class="token punctuation">.</span>num_parts <span class="token operator">=</span> num_parts
        sigma <span class="token operator">=</span> self<span class="token punctuation">.</span>output_res<span class="token operator">/</span><span class="token number">64</span>  <span class="token comment">#sigma=2</span>
        self<span class="token punctuation">.</span>sigma <span class="token operator">=</span> sigma
        size <span class="token operator">=</span> <span class="token number">6</span><span class="token operator">*</span>sigma <span class="token operator">+</span> <span class="token number">3</span>  <span class="token comment">#size=15</span>
        x <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">)</span>
        <span class="token comment">#返回一个array([0.,1.,...,15.])的数据</span>
        y <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span>
        <span class="token comment">#np.newaxis 为 numpy.ndarray（多维数组）增加一个轴，</span>
        <span class="token comment">#np.newaxis 在使用和功能上等价于 None，其实就是 None 的一个别名</span>
        <span class="token comment">#x[:, np.newaxis]=array([[0],[1],[2]]) 行向量变列向量</span>
        x0<span class="token punctuation">,</span> y0 <span class="token operator">=</span> <span class="token number">3</span><span class="token operator">*</span>sigma <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">*</span>sigma <span class="token operator">+</span> <span class="token number">1</span>    <span class="token comment">#x0=y0=7</span>
        self<span class="token punctuation">.</span>g <span class="token operator">=</span> np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">-</span> x0<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y <span class="token operator">-</span> y0<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> sigma <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        

        <span class="token triple-quoted-string string">'''根据keypoints数量生成heatmaps张量'''</span>
    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> keypoints<span class="token punctuation">)</span><span class="token punctuation">:</span>
        hms <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>shape <span class="token operator">=</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>num_parts<span class="token punctuation">,</span> self<span class="token punctuation">.</span>output_res<span class="token punctuation">,</span> self<span class="token punctuation">.</span>output_res<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype <span class="token operator">=</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        <span class="token comment">#hms是 17x128x128的张量</span>
        sigma <span class="token operator">=</span> self<span class="token punctuation">.</span>sigma
        <span class="token keyword">for</span> p <span class="token keyword">in</span> keypoints<span class="token punctuation">:</span>
            <span class="token keyword">for</span> idx<span class="token punctuation">,</span> pt <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment">#eumerate用法：遍历list[],输出序号和序号对应的数值</span>
                <span class="token keyword">if</span> pt<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">></span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token comment">#pt[2]代表是否可见？</span>
                    x<span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>pt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>pt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> x<span class="token operator">&lt;</span><span class="token number">0</span> <span class="token operator">or</span> y<span class="token operator">&lt;</span><span class="token number">0</span> <span class="token operator">or</span> x<span class="token operator">>=</span>self<span class="token punctuation">.</span>output_res <span class="token operator">or</span> y<span class="token operator">>=</span>self<span class="token punctuation">.</span>output_res<span class="token punctuation">:</span>
                        <span class="token comment">#print('not in', x, y)</span>
                        <span class="token keyword">continue</span>
                    ul <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">3</span><span class="token operator">*</span>sigma <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>y <span class="token operator">-</span> <span class="token number">3</span><span class="token operator">*</span>sigma <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
                    br <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">3</span><span class="token operator">*</span>sigma <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>y <span class="token operator">+</span> <span class="token number">3</span><span class="token operator">*</span>sigma <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span>

                    c<span class="token punctuation">,</span>d <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span>ul<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span>br<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>output_res<span class="token punctuation">)</span> <span class="token operator">-</span> ul<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                    a<span class="token punctuation">,</span>b <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span>ul<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span>br<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>output_res<span class="token punctuation">)</span> <span class="token operator">-</span> ul<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

                    cc<span class="token punctuation">,</span>dd <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> ul<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span>br<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>output_res<span class="token punctuation">)</span>
                    aa<span class="token punctuation">,</span>bb <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> ul<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span>br<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>output_res<span class="token punctuation">)</span>
                    hms<span class="token punctuation">[</span>idx<span class="token punctuation">,</span> aa<span class="token punctuation">:</span>bb<span class="token punctuation">,</span>cc<span class="token punctuation">:</span>dd<span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span>hms<span class="token punctuation">[</span>idx<span class="token punctuation">,</span> aa<span class="token punctuation">:</span>bb<span class="token punctuation">,</span>cc<span class="token punctuation">:</span>dd<span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>g<span class="token punctuation">[</span>a<span class="token punctuation">:</span>b<span class="token punctuation">,</span>c<span class="token punctuation">:</span>d<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> hms
<span class="token number">2018.6</span><span class="token number">.27</span>
<span class="token triple-quoted-string string">'''utils/misc.py'''</span>
<span class="token triple-quoted-string string">'''作者调用网路写的代码'''</span>
<span class="token keyword">def</span> <span class="token function">importNet</span><span class="token punctuation">(</span>net<span class="token punctuation">)</span><span class="token punctuation">:</span>
    t <span class="token operator">=</span> net<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span>  <span class="token comment">#比如net='models.posenet.PoseNet'  t=['models', 'posenet', 'PoseNet']</span>
    path<span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">'.'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>     <span class="token comment"># path='models.posenet' name=PoseNet，</span>
    module <span class="token operator">=</span> importlib<span class="token punctuation">.</span>import_module<span class="token punctuation">(</span>path<span class="token punctuation">)</span>    <span class="token comment"># 这些net的名称全部储存在一个configJSON文件里</span>
    <span class="token keyword">return</span> <span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token string">'module.{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">#这里的eval 什么意思？？是怎么用在make_network里面的。字符串变成了函数。</span>

    <span class="token triple-quoted-string string">"""def eval(source, globals, locals) 这里就是eval的定义，似乎是把 字符串变成了 函数或者python对象 的入口？
这是注释：Evaluate the given source in the context of globals and locals.
The source may be a string representing a Python expression or a code object as returned by compile(). The globals must be a dictionary and locals can be any mapping, defaulting to the current globals and locals. If only globals is given, locals defaults to it."""</span>

<span class="token triple-quoted-string string">'''train.py  主函数'''</span>
<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    func<span class="token punctuation">,</span> config <span class="token operator">=</span> init<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#初始化训练参数，其中func是make_network()读取batch数据的函数</span>
    data_func <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'data_provider'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>init<span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token comment">#产生train和valid两种phase的数据迭代器</span>
    train<span class="token punctuation">(</span>func<span class="token punctuation">,</span> data_func<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token comment">#训练函数，batch生成+batch送入训练+配置</span>
   <span class="token comment">#在训练函数的里面要考虑每个迭代周期epoch里面，保存checkpoint，每次实验海可以选择从上一次进行的checkpoint进行。</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">'''task/pose.py   make_network函数处理batch数据，在train（）函数里phase的选择是train和valid两种数据迭代器。然后把迭代器里的每个batch-size数据送到make_network()'''</span>
<span class="token keyword">def</span> <span class="token function">make_network</span><span class="token punctuation">(</span>configs<span class="token punctuation">)</span><span class="token punctuation">:</span>    
    PoseNet <span class="token operator">=</span> importNet<span class="token punctuation">(</span>configs<span class="token punctuation">[</span><span class="token string">'network'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment">#现在的PoseNet变成了什么</span>
    train_cfg <span class="token operator">=</span> configs<span class="token punctuation">[</span><span class="token string">'train'</span><span class="token punctuation">]</span>
    config <span class="token operator">=</span> configs<span class="token punctuation">[</span><span class="token string">'inference'</span><span class="token punctuation">]</span>

    poseNet <span class="token operator">=</span> PoseNet<span class="token punctuation">(</span><span class="token operator">**</span>config<span class="token punctuation">)</span> <span class="token comment"># **config直接表示configs['inference']里的一组 字典</span>

    forward_net <span class="token operator">=</span> DataParallel<span class="token punctuation">(</span>poseNet<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#平行的前向计算</span>
    <span class="token keyword">def</span> <span class="token function">calc_loss</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> poseNet<span class="token punctuation">.</span>calc_loss<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>

    config<span class="token punctuation">[</span><span class="token string">'net'</span><span class="token punctuation">]</span> <span class="token operator">=</span> Trainer<span class="token punctuation">(</span>forward_net<span class="token punctuation">,</span> configs<span class="token punctuation">[</span><span class="token string">'inference'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'keys'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> calc_loss<span class="token punctuation">)</span> <span class="token comment">#trianer类，config[]能指代类？，</span>
    train_cfg<span class="token punctuation">[</span><span class="token string">'optimizer'</span><span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">'net'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> train_cfg<span class="token punctuation">[</span><span class="token string">'learning_rate'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token operator">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>exp_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>exp_path<span class="token punctuation">)</span>
    logger <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>exp_path<span class="token punctuation">,</span> <span class="token string">'log'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'a+'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">make_train</span><span class="token punctuation">(</span>batch_id<span class="token punctuation">,</span> config<span class="token punctuation">,</span> phase<span class="token punctuation">,</span> <span class="token operator">**</span>inputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> inputs<span class="token punctuation">:</span>
            inputs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> make_input<span class="token punctuation">(</span>inputs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>

        net <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'inference'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'net'</span><span class="token punctuation">]</span>
        config<span class="token punctuation">[</span><span class="token string">'batch_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> batch_id

        <span class="token keyword">if</span> phase <span class="token operator">!=</span> <span class="token string">'inference'</span><span class="token punctuation">:</span>
            result <span class="token operator">=</span> net<span class="token punctuation">(</span>inputs<span class="token punctuation">[</span><span class="token string">'imgs'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">**</span><span class="token punctuation">{</span>i<span class="token punctuation">:</span>inputs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> inputs <span class="token keyword">if</span> i<span class="token operator">!=</span><span class="token string">'imgs'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

            num_loss <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">'train'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'loss'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># =3?</span>
            <span class="token triple-quoted-string string">'''config['train']['loss']
            'loss': [
            ['push_loss', 1e-3],
            ['pull_loss', 1e-3],
            ['detection_loss', 1],'''</span>
            <span class="token comment">## I use the last outputs as the loss</span>
            <span class="token comment">## the weights of the loss are controlled by config['train']['loss'] </span>
            losses <span class="token operator">=</span> <span class="token punctuation">{</span>i<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span> result<span class="token punctuation">[</span><span class="token operator">-</span>num_loss <span class="token operator">+</span> idx<span class="token punctuation">]</span><span class="token operator">*</span>i<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">for</span> idx<span class="token punctuation">,</span> i <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">'train'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'loss'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>

            loss <span class="token operator">=</span> <span class="token number">0</span>
            toprint <span class="token operator">=</span> <span class="token string">'\n{}: '</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>batch_id<span class="token punctuation">)</span>
            <span class="token keyword">for</span> i <span class="token keyword">in</span> losses<span class="token punctuation">:</span>
                loss <span class="token operator">=</span> loss <span class="token operator">+</span> torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>losses<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>

                my_loss <span class="token operator">=</span> make_output<span class="token punctuation">(</span> losses<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">)</span>
                my_loss <span class="token operator">=</span> my_loss<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>axis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span>

                <span class="token keyword">if</span> my_loss<span class="token punctuation">.</span>size <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
                    toprint <span class="token operator">+=</span> <span class="token string">' {}: {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token punctuation">(</span>my_loss<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'.8f'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    toprint <span class="token operator">+=</span> <span class="token string">'\n{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
                    <span class="token keyword">for</span> j <span class="token keyword">in</span> my_loss<span class="token punctuation">:</span>
                        toprint <span class="token operator">+=</span> <span class="token string">' {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">format</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'.8f'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

            logger<span class="token punctuation">.</span>write<span class="token punctuation">(</span>toprint<span class="token punctuation">)</span>
            logger<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> batch_id <span class="token operator">==</span> <span class="token number">200000</span><span class="token punctuation">:</span>
                <span class="token comment">## decrease the learning rate after 200000 iterations</span>
                <span class="token keyword">for</span> param_group <span class="token keyword">in</span> optimizer<span class="token punctuation">.</span>param_groups<span class="token punctuation">:</span>
                    param_group<span class="token punctuation">[</span><span class="token string">'lr'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">5</span>

            optimizer <span class="token operator">=</span> train_cfg<span class="token punctuation">[</span><span class="token string">'optimizer'</span><span class="token punctuation">]</span>
            optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
            loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
            optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            out <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            net <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            result <span class="token operator">=</span> net<span class="token punctuation">(</span><span class="token operator">**</span>inputs<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token builtin">type</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token builtin">list</span> <span class="token operator">and</span> <span class="token builtin">type</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token builtin">tuple</span><span class="token punctuation">:</span>
                result <span class="token operator">=</span> <span class="token punctuation">[</span>result<span class="token punctuation">]</span>
            out<span class="token punctuation">[</span><span class="token string">'preds'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>make_output<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> result<span class="token punctuation">]</span>
            <span class="token keyword">return</span> out
    <span class="token keyword">return</span> make_train

<span class="token triple-quoted-string string">'''data/coco_pose/dp.py  init(config)这个函数负责从phase是train和valid从数据库里生成迭代器'''</span>
<span class="token keyword">def</span> <span class="token function">init</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">:</span>
    batchsize <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'train'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'batchsize'</span><span class="token punctuation">]</span>
    current_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>append<span class="token punctuation">(</span>current_path<span class="token punctuation">)</span>
    <span class="token keyword">import</span> ref <span class="token keyword">as</span> ds
    ds<span class="token punctuation">.</span>init<span class="token punctuation">(</span><span class="token punctuation">)</span>

    train<span class="token punctuation">,</span> valid <span class="token operator">=</span> ds<span class="token punctuation">.</span>setup_val_split<span class="token punctuation">(</span><span class="token punctuation">)</span>
    dataset <span class="token operator">=</span> <span class="token punctuation">{</span> key<span class="token punctuation">:</span> Dataset<span class="token punctuation">(</span>config<span class="token punctuation">,</span> ds<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token keyword">for</span> key<span class="token punctuation">,</span> data <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span> <span class="token punctuation">[</span><span class="token string">'train'</span><span class="token punctuation">,</span> <span class="token string">'valid'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>train<span class="token punctuation">,</span> valid<span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">}</span>

    use_data_loader <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'train'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'use_data_loader'</span><span class="token punctuation">]</span>

    loaders <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> key <span class="token keyword">in</span> dataset<span class="token punctuation">:</span>
        loaders<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>dataset<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> batch_size<span class="token operator">=</span>batchsize<span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> num_workers<span class="token operator">=</span>config<span class="token punctuation">[</span><span class="token string">'train'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'num_workers'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pin_memory<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">gen</span><span class="token punctuation">(</span>phase<span class="token punctuation">)</span><span class="token punctuation">:</span>
        batchsize <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'train'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'batchsize'</span><span class="token punctuation">]</span>
        batchnum <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'train'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'{}_iters'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>phase<span class="token punctuation">)</span><span class="token punctuation">]</span>
        loader <span class="token operator">=</span> loaders<span class="token punctuation">[</span>phase<span class="token punctuation">]</span><span class="token punctuation">.</span>__iter__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>batchnum<span class="token punctuation">)</span><span class="token punctuation">:</span>
            imgs<span class="token punctuation">,</span> masks<span class="token punctuation">,</span> keypoints<span class="token punctuation">,</span> heatmaps <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>loader<span class="token punctuation">)</span>
            <span class="token keyword">yield</span> <span class="token punctuation">{</span>
                <span class="token string">'imgs'</span><span class="token punctuation">:</span> imgs<span class="token punctuation">,</span>
                <span class="token string">'masks'</span><span class="token punctuation">:</span> masks<span class="token punctuation">,</span>
                <span class="token string">'heatmaps'</span><span class="token punctuation">:</span> heatmaps<span class="token punctuation">,</span>
                <span class="token string">'keypoints'</span><span class="token punctuation">:</span> keypoints
            <span class="token punctuation">}</span>


    <span class="token keyword">return</span> <span class="token keyword">lambda</span> key<span class="token punctuation">:</span> gen<span class="token punctuation">(</span>key<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">'''下面的这个操作是打开一个保存序号的文件：'525232\n', '132019\n', '349193\n', '263094\n',，转换成[525232,132019,349193,263094],使用了map(function,*iterables),其中
lambda x:func（x）是一种简化的表达式匿名函数，int(x.strip())为表达式，strip（）表示去掉换行符\n, f.readlines()表示map()函数的迭代器参数'''</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>ref_dir <span class="token operator">+</span> <span class="token string">'/valid_id'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        valid_id <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span><span class="token builtin">int</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    valid_id_set <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span>valid_id<span class="token punctuation">)</span>


<span class="token triple-quoted-string string">'''task/loss.py  loss函数的误差是如何定义的，pytorch最方便的地方在于用loss.backward()一个函数直接封装了梯度
反向传播'''</span>
<span class="token keyword">def</span> <span class="token function">singleTagLoss</span><span class="token punctuation">(</span>pred_tag<span class="token punctuation">,</span> keypoints<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    associative embedding loss for one image
    """</span>
    eps <span class="token operator">=</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">6</span>
    tags <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    pull <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> keypoints<span class="token punctuation">:</span>
        tmp <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> i<span class="token punctuation">:</span>
            <span class="token keyword">if</span> j<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">></span><span class="token number">0</span><span class="token punctuation">:</span>
                tmp<span class="token punctuation">.</span>append<span class="token punctuation">(</span>pred_tag<span class="token punctuation">[</span>j<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        tmp <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>tmp<span class="token punctuation">)</span>
        tags<span class="token punctuation">.</span>append<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        pull <span class="token operator">=</span> pull <span class="token operator">+</span>  torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">(</span>tmp <span class="token operator">-</span> tags<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>expand_as<span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>tags<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> make_input<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> make_input<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    tags <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>tags<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span>

    num <span class="token operator">=</span> tags<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    size <span class="token operator">=</span> <span class="token punctuation">(</span>num<span class="token punctuation">,</span> num<span class="token punctuation">,</span> tags<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    A <span class="token operator">=</span> tags<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>expand<span class="token punctuation">(</span><span class="token operator">*</span>size<span class="token punctuation">)</span>
    B <span class="token operator">=</span> A<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

    diff <span class="token operator">=</span> A <span class="token operator">-</span> B
    diff <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">pow</span><span class="token punctuation">(</span>diff<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span>
    push <span class="token operator">=</span> torch<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token operator">-</span>diff<span class="token punctuation">)</span>
    push <span class="token operator">=</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>push<span class="token punctuation">)</span> <span class="token operator">-</span> num<span class="token punctuation">)</span>
    <span class="token keyword">return</span> push<span class="token operator">/</span><span class="token punctuation">(</span><span class="token punctuation">(</span>num <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> num <span class="token operator">+</span> eps<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">,</span> pull<span class="token operator">/</span><span class="token punctuation">(</span>num <span class="token operator">+</span> eps<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">tagLoss</span><span class="token punctuation">(</span>tags<span class="token punctuation">,</span> keypoints<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    accumulate the tag loss for each image in the batch
    """</span>
    pushes<span class="token punctuation">,</span> pulls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    keypoints <span class="token operator">=</span> keypoints<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>tags<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        push<span class="token punctuation">,</span> pull <span class="token operator">=</span> singleTagLoss<span class="token punctuation">(</span>tags<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> keypoints<span class="token punctuation">[</span>i<span class="token operator">%</span><span class="token builtin">len</span><span class="token punctuation">(</span>keypoints<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        pushes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>push<span class="token punctuation">)</span>
        pulls<span class="token punctuation">.</span>append<span class="token punctuation">(</span>pull<span class="token punctuation">)</span>
    <span class="token keyword">return</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>pushes<span class="token punctuation">)</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>pulls<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">test_tag_loss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    t <span class="token operator">=</span> make_input<span class="token punctuation">(</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requires_grad<span class="token operator">=</span><span class="token boolean">True</span> <span class="token punctuation">)</span>
    t<span class="token punctuation">.</span>register_hook<span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'t'</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span>
    loss <span class="token operator">=</span> singleTagLoss<span class="token punctuation">(</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>loss<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    test_tag_loss<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token triple-quoted-string string">'''test.py'''</span>
<span class="token keyword">def</span> <span class="token function">multiperson</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> func<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token triple-quoted-string string">"""
1. Resize the image to different scales and pass each scale through the network
2. Merge the outputs across scales and find people by HeatmapParser
3. Find the missing joints of the people with a second pass of the heatmaps
"""</span>
<span class="token keyword">if</span> mode <span class="token operator">==</span> <span class="token string">'multi'</span><span class="token punctuation">:</span>
    scales <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">]</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    scales <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

height<span class="token punctuation">,</span> width <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>      <span class="token comment"># 假设 h=1000，w=500</span>
center <span class="token operator">=</span> <span class="token punctuation">(</span>width<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> height<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment">#（250，500）</span>
dets<span class="token punctuation">,</span> tags <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> idx<span class="token punctuation">,</span> i <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>scales<span class="token punctuation">)</span><span class="token punctuation">:</span>
    scale <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>height<span class="token punctuation">,</span> width<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">200</span>    <span class="token comment"># 5</span>
    input_res <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>height<span class="token punctuation">,</span> width<span class="token punctuation">)</span>
    inp_res <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">*</span> <span class="token number">512</span> <span class="token operator">+</span> <span class="token number">63</span><span class="token punctuation">)</span><span class="token operator">//</span><span class="token number">64</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>  <span class="token comment">#取整 对于i=2，1，0.5， inp_res=1024,512,256</span>
    res <span class="token operator">=</span> <span class="token punctuation">(</span>inp_res<span class="token punctuation">,</span> inp_res<span class="token punctuation">)</span>

    mat_ <span class="token operator">=</span> get_transform<span class="token punctuation">(</span>center<span class="token punctuation">,</span> scale<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>       <span class="token comment">#task/misc.py</span>
    inp <span class="token operator">=</span> cv2<span class="token punctuation">.</span>warpAffine<span class="token punctuation">(</span>img<span class="token punctuation">,</span> mat_<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">255</span>      <span class="token comment">#opencv的变换矩阵</span>

    <span class="token keyword">def</span> <span class="token function">array2dict</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            <span class="token string">'det'</span><span class="token punctuation">:</span> tmp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">'tag'</span><span class="token punctuation">:</span> tmp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">:</span><span class="token number">34</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>

    tmp1 <span class="token operator">=</span> array2dict<span class="token punctuation">(</span>func<span class="token punctuation">(</span><span class="token punctuation">[</span>inp<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    tmp2 <span class="token operator">=</span> array2dict<span class="token punctuation">(</span>func<span class="token punctuation">(</span><span class="token punctuation">[</span>inp<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    tmp <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> ii <span class="token keyword">in</span> tmp1<span class="token punctuation">:</span>
        tmp<span class="token punctuation">[</span>ii<span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">(</span>tmp1<span class="token punctuation">[</span>ii<span class="token punctuation">]</span><span class="token punctuation">,</span> tmp2<span class="token punctuation">[</span>ii<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

    det <span class="token operator">=</span> tmp<span class="token punctuation">[</span><span class="token string">'det'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> tmp<span class="token punctuation">[</span><span class="token string">'det'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>flipRef<span class="token punctuation">]</span>
    <span class="token keyword">if</span> det<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">10</span><span class="token punctuation">:</span>
        <span class="token keyword">continue</span>
    <span class="token keyword">if</span> dets <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        dets <span class="token operator">=</span> det
        mat <span class="token operator">=</span> np<span class="token punctuation">.</span>linalg<span class="token punctuation">.</span>pinv<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>mat_<span class="token punctuation">)</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        dets <span class="token operator">=</span> dets <span class="token operator">+</span> resize<span class="token punctuation">(</span>det<span class="token punctuation">,</span> dets<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 

    <span class="token keyword">if</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0.5</span><span class="token punctuation">:</span>
        res <span class="token operator">=</span> dets<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>
        tags <span class="token operator">+=</span> <span class="token punctuation">[</span>resize<span class="token punctuation">(</span>tmp<span class="token punctuation">[</span><span class="token string">'tag'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">,</span> resize<span class="token punctuation">(</span>tmp<span class="token punctuation">[</span><span class="token string">'tag'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>flipRef<span class="token punctuation">]</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token keyword">if</span> dets <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token operator">or</span> <span class="token builtin">len</span><span class="token punctuation">(</span>tags<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

tags <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>i<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> tags<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
dets <span class="token operator">=</span> dets<span class="token operator">/</span><span class="token builtin">len</span><span class="token punctuation">(</span>scales<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span>

dets <span class="token operator">=</span> np<span class="token punctuation">.</span>minimum<span class="token punctuation">(</span>dets<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
grouped <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span><span class="token punctuation">[</span>dets<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span><span class="token punctuation">[</span>tags<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>


scores <span class="token operator">=</span> <span class="token punctuation">[</span>i<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span>  i <span class="token keyword">in</span> grouped<span class="token punctuation">]</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>grouped<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    grouped<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> refine<span class="token punctuation">(</span>dets<span class="token punctuation">,</span> tags<span class="token punctuation">,</span> grouped<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>grouped<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
    grouped<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> kpt_affine<span class="token punctuation">(</span>grouped<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> mat<span class="token punctuation">)</span>
<span class="token keyword">return</span> grouped<span class="token punctuation">,</span> scores
</pre><h2 class="mume-header" id="checkpoint%E6%98%AF%E4%BB%80%E4%B9%88">checkpoint是什么</h2>

<p><a href="http://www.atyun.com/12192.html">http://www.atyun.com/12192.html</a><br>
防止在训练模型时信息丢失的检查点 checkpoint 机制。<br>
如果你玩过电子游戏，你就会明白为什么检查点（chekpoint）是有用的了。举个例子，有时候你会在一个大Boss的城堡前把你的游戏的当前进度保存起来——以防进入城堡里面就Game Over了。</p>
<p>机器学习和深度学习实验中的检查点本质上是一样的，它们都是一种保存你实验状态的方法，这样你就可以从你离开的地方开始继续学习。</p>
<p>Keras文档为检查点提供了一个很好的解释:</p>
<ul>
<li>
<p>模型的体系结构，允许你重新创建模型</p>
</li>
<li>
<p>模型的权重</p>
</li>
<li>
<p>训练配置(损失、优化器、epochs和其他元信息</p>
</li>
<li>
<p>优化器的状态，允许在你离开的地方恢复训练</p>
</li>
<li>
<p><strong>Markdown和扩展Markdown简洁的语法</strong></p>
</li>
<li>
<p><strong>代码块高亮</strong></p>
</li>
<li>
<p><strong>图片链接和图片上传</strong></p>
</li>
<li>
<p><strong><em>LaTex</em>数学公式</strong></p>
</li>
<li>
<p><strong>UML序列图和流程图</strong></p>
</li>
<li>
<p><strong>离线写博客</strong></p>
</li>
<li>
<p><strong>导入导出Markdown文件</strong></p>
</li>
<li>
<p><strong>丰富的快捷键</strong><br>
使用简单的符号标识不同的标题，将某些文字标记为<strong>粗体</strong>或者<em>斜体</em>，创建一个<a href="http://www.csdn.net">链接</a>等，详细语法参考帮助？。</p>
</li>
</ul>
<p>本编辑器支持 <strong>Markdown Extra</strong> , 　扩展了很多好用的功能。具体请参考<a href="https://github.com/jmcmanus/pagedown-extra" title="Pagedown Extra">Github</a>.</p>
<h3 class="mume-header" id="%E8%A1%A8%E6%A0%BC">表格</h3>

<p><strong>Markdown　Extra</strong>　表格语法：</p>
<table>
<thead>
<tr>
<th>项目</th>
<th>价格</th>
</tr>
</thead>
<tbody>
<tr>
<td>Computer</td>
<td>$1600</td>
</tr>
<tr>
<td>Phone</td>
<td>$12</td>
</tr>
<tr>
<td>Pipe</td>
<td>$1</td>
</tr>
</tbody>
</table>
<p>可以使用冒号来定义对齐方式：</p>
<table>
<thead>
<tr>
<th style="text-align:left">项目</th>
<th style="text-align:right">价格</th>
<th style="text-align:center">数量</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Computer</td>
<td style="text-align:right">1600 元</td>
<td style="text-align:center">5</td>
</tr>
<tr>
<td style="text-align:left">Phone</td>
<td style="text-align:right">12 元</td>
<td style="text-align:center">12</td>
</tr>
<tr>
<td style="text-align:left">Pipe</td>
<td style="text-align:right">1 元</td>
<td style="text-align:center">234</td>
</tr>
</tbody>
</table>
<h3 class="mume-header" id="%E5%AE%9A%E4%B9%89%E5%88%97%E8%A1%A8">定义列表</h3>

<p><strong>Markdown　Extra</strong>　定义列表语法：<br>
项目１<br>
项目２<br>
:   定义 A<br>
:   定义 B</p>
<dl>
<dt>项目３</dt>
<dd>
<p>定义 C</p>
</dd>
<dd>
<p>定义 D</p>
<blockquote>
<p>定义D内容</p>
</blockquote>
</dd>
</dl>
<h3 class="mume-header" id="%E4%BB%A3%E7%A0%81%E5%9D%97">代码块</h3>

<p>代码块语法遵循标准markdown代码，例如：</p>
<pre data-role="codeBlock" data-info="python" class="language-python">@requires_authorization
<span class="token keyword">def</span> <span class="token function">somefunc</span><span class="token punctuation">(</span>param1<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span> param2<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token triple-quoted-string string">'''A docstring'''</span>
<span class="token keyword">if</span> param1 <span class="token operator">></span> param2<span class="token punctuation">:</span> <span class="token comment"># interesting</span>
    <span class="token keyword">print</span> <span class="token string">'Greater'</span>
<span class="token keyword">return</span> <span class="token punctuation">(</span>param2 <span class="token operator">-</span> param1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">or</span> <span class="token boolean">None</span>
<span class="token keyword">class</span> <span class="token class-name">SomeClass</span><span class="token punctuation">:</span>
<span class="token keyword">pass</span>
<span class="token operator">>></span><span class="token operator">></span> message <span class="token operator">=</span> <span class="token triple-quoted-string string">'''interpreter
... prompt'''</span>
</pre><h3 class="mume-header" id="%E8%84%9A%E6%B3%A8">脚注</h3>

<p>生成一个脚注<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>.</p>
<h3 class="mume-header" id="%E7%9B%AE%E5%BD%95">目录</h3>

<p>用 <code>[TOC]</code>来生成目录：</p>
<ul>
<li><a href="#associative-embedding-end-to-end-learning-for-joint-detection-and-grouping">Associative embedding: End-to-End Learning for Joint Detection and Grouping</a>
<ul>
<li><a href="#%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB">论文阅读</a></li>
<li><a href="#%E6%94%B9%E8%BF%9B%E6%83%B3%E6%B3%95">改进想法</a></li>
<li><a href="#%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5">工程实践</a></li>
<li><a href="#checkpoint%E6%98%AF%E4%BB%80%E4%B9%88">checkpoint是什么</a>
<ul>
<li><a href="#%E8%A1%A8%E6%A0%BC">表格</a></li>
<li><a href="#%E5%AE%9A%E4%B9%89%E5%88%97%E8%A1%A8">定义列表</a></li>
<li><a href="#%E4%BB%A3%E7%A0%81%E5%9D%97">代码块</a></li>
<li><a href="#%E8%84%9A%E6%B3%A8">脚注</a></li>
<li><a href="#%E7%9B%AE%E5%BD%95">目录</a></li>
<li><a href="#%E6%95%B0%E5%AD%A6%E5%85%AC%E5%BC%8F">数学公式</a></li>
<li><a href="#uml-%E5%9B%BE">UML 图:</a></li>
</ul>
</li>
<li><a href="#%E7%A6%BB%E7%BA%BF%E5%86%99%E5%8D%9A%E5%AE%A2">离线写博客</a></li>
<li><a href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E5%85%BC%E5%AE%B9">浏览器兼容</a></li>
</ul>
</li>
</ul>
<h3 class="mume-header" id="%E6%95%B0%E5%AD%A6%E5%85%AC%E5%BC%8F">数学公式</h3>

<p>使用MathJax渲染<em>LaTex</em> 数学公式，详见<a href="http://math.stackexchange.com/">math.stackexchange.com</a>.</p>
<ul>
<li>行内公式，数学公式为：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="normal">Γ</mi><mo>(</mo><mi>n</mi><mo>)</mo><mo>=</mo><mo>(</mo><mi>n</mi><mo>−</mo><mn>1</mn><mo>)</mo><mo>!</mo><mspace width="1em"></mspace><mi mathvariant="normal">∀</mi><mi>n</mi><mo>∈</mo><mi mathvariant="double-struck">N</mi></mrow><annotation encoding="application/x-tex">\Gamma(n) = (n-1)!\quad\forall n\in\mathbb N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base"><span class="mord">Γ</span><span class="mopen">(</span><span class="mord mathit">n</span><span class="mclose">)</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mopen">(</span><span class="mord mathit">n</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mclose">!</span><span class="mspace quad"></span><span class="mord">∀</span><span class="mord mathit">n</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord mathbb">N</span></span></span></span>。</li>
<li>块级公式：</li>
</ul>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>x</mi><mo>=</mo><mfrac><mrow><mo>−</mo><mi>b</mi><mo>±</mo><msqrt><mrow><msup><mi>b</mi><mn>2</mn></msup><mo>−</mo><mn>4</mn><mi>a</mi><mi>c</mi></mrow></msqrt></mrow><mrow><mn>2</mn><mi>a</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">x = \dfrac{-b \pm \sqrt{b^2 - 4ac}}{2a}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.590389em;"></span><span class="strut bottom" style="height:2.276389em;vertical-align:-0.686em;"></span><span class="base"><span class="mord mathit">x</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.590389em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mord mathit">a</span></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.2em;"><svg width="400em" height="0.2em" viewBox="0 0 400000 200" preserveAspectRatio="xMinYMin slice"><path d="M0 80H400000 v40H0z M0 80H400000 v40H0z"></path></svg></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">−</span><span class="mord mathit">b</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">±</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.913389em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathit">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord">4</span><span class="mord mathit">a</span><span class="mord mathit">c</span></span></span><span style="top:-2.873389em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,
-10,-9.5,-14c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54c44.2,-33.3,65.8,
-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10s173,378,173,378c0.7,0,
35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429c69,-144,104.5,-217.7,106.5,
-221c5.3,-9.3,12,-14,20,-14H400000v40H845.2724s-225.272,467,-225.272,467
s-235,486,-235,486c-2.7,4.7,-9,7,-19,7c-6,0,-10,-1,-12,-3s-194,-422,-194,-422
s-65,47,-65,47z M834 80H400000v40H845z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.12661100000000003em;"></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>更多LaTex语法请参考 <a href="http://meta.math.stackexchange.com/questions/5020/mathjax-basic-tutorial-and-quick-reference">这儿</a>.</p>
<h3 class="mume-header" id="uml-%E5%9B%BE">UML 图:</h3>

<p>可以渲染序列图：</p>
<div class="sequence">张三->李四: 嘿，小四儿, 写博客了没?
Note right of 李四: 李四愣了一下，说：
李四-->张三: 忙得吐血，哪有时间写。
</div><p>或者流程图：</p>
<div class="flow">st=>start: 开始
e=>end: 结束
op=>operation: 我的操作
cond=>condition: 确认？

st->op->cond
cond(yes)->e
cond(no)->op
</div><ul>
<li>关于 <strong>序列图</strong> 语法，参考 <a href="http://bramp.github.io/js-sequence-diagrams/">这儿</a>,</li>
<li>关于 <strong>流程图</strong> 语法，参考 <a href="http://adrai.github.io/flowchart.js/">这儿</a>.</li>
</ul>
<h2 class="mume-header" id="%E7%A6%BB%E7%BA%BF%E5%86%99%E5%8D%9A%E5%AE%A2">离线写博客</h2>

<p>即使用户在没有网络的情况下，也可以通过本编辑器离线写博客（直接在曾经使用过的浏览器中输入<a href="http://write.blog.csdn.net/mdeditor">write.blog.csdn.net/mdeditor</a>即可。<strong>Markdown编辑器</strong>使用浏览器离线存储将内容保存在本地。</p>
<p>用户写博客的过程中，内容实时保存在浏览器缓存中，在用户关闭浏览器或者其它异常情况下，内容不会丢失。用户再次打开浏览器时，会显示上次用户正在编辑的没有发表的内容。</p>
<p>博客发表后，本地缓存将被删除。</p>
<p>用户可以选择 <i class="icon-disk"></i> 把正在写的博客保存到服务器草稿箱，即使换浏览器或者清除缓存，内容也不会丢失。</p>
<blockquote>
<p>**注意：**虽然浏览器存储大部分时候都比较可靠，但为了您的数据安全，在联网后，<strong>请务必及时发表或者保存到服务器草稿箱</strong>。</p>
</blockquote>
<h2 class="mume-header" id="%E6%B5%8F%E8%A7%88%E5%99%A8%E5%85%BC%E5%AE%B9">浏览器兼容</h2>

<ol>
<li>目前，本编辑器对Chrome浏览器支持最为完整。建议大家使用较新版本的Chrome。</li>
<li>IE９以下不支持</li>
<li>IE９，１０，１１存在以下问题
<ol>
<li>s</li>
<li>IE9不支持文件导入导出</li>
<li>IE10不支持拖拽文件导入</li>
</ol>
</li>
</ol>
<hr>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>这里是 <strong>脚注</strong> 的 <em>内容</em>. <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>

  </div>

  <p>&nbsp;</p>
  <!--以上为修改部分 --><!--以上为修改部分 --><!--以上为修改部分 --><!--以上为修改部分 --><!--以上为修改部分 -->
  <!--以上为修改部分 --><!--以上为修改部分 --><!--以上为修改部分 --><!--以上为修改部分 --><!--以上为修改部分 -->
  
  <script type="text/javascript" src="/html_style/foot.js"></script>
  </body>
  </html>